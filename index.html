<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NRC Cape Creator</title>
  <link rel="icon" type="image/png" href="muhehehe.png" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="wrapper">
    <h1>NRC Cape Creator</h1>

    <div class="controls">
      <label>Select image for the "Front":</label>
      <input type="file" id="frontImageInput" accept="image/*" />

      <label>Select image for the "Back":</label>
      <input type="file" id="backImageInput" accept="image/*" />

      <label>Select image for the "Elytra":</label>
      <input type="file" id="elytraImageInput" accept="image/*" />

      <div id="gradientControls" style="margin-left:12px;">
        <div id="gradientColors"></div>
        <button id="addColorBtn" type="button">+ Add color</button>

        <label>Direction:</label>
        <select id="gradDirection">
          <option value="vertical">Vertical</option>
          <option value="horizontal">Horizontal</option>
        </select>
      </div>

      <button id="downloadBtn" type="button">Download Cape</button>
      <button id="resetBtn" type="button">Reset</button>
    </div>

    <canvas id="capeCanvas" width="512" height="256"></canvas>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const canvas = document.getElementById("capeCanvas");
      const ctx = canvas.getContext("2d");

      const templateImg = new Image();
      templateImg.src = "nrc_cape_template.png";

      let frontImage = null;
      let backImage = null;
      let elytraImage = null;

      const FRONT_X = 8, FRONT_Y = 8, FRONT_W = 80, FRONT_H = 128;
      const BACK_X = 96, BACK_Y = 8, BACK_W = 80, BACK_H = 128;
      const ELYTRA_X = 288, ELYTRA_Y = 16, ELYTRA_W = 80, ELYTRA_H = 160;

      const gradientColorsEl = document.getElementById("gradientColors");
      const addColorBtn = document.getElementById("addColorBtn");
      const gradDirectionEl = document.getElementById("gradDirection");

      let templateReady = false;

      templateImg.onload = () => {
        templateReady = true;
        drawCape();
      };
      templateImg.onerror = () => {
        templateReady = false;
        drawCape();
      };

      function seedInitialGradientStops() {
        if (gradientColorsEl.querySelectorAll('input[type="color"]').length === 0) {
          addGradientColor("#002aff");
        }
      }

      function addGradientColor(value = "#ffffff") {
        const index = gradientColorsEl.querySelectorAll('input[type="color"]').length + 1;

        const row = document.createElement("div");
        row.className = "grad-row";
        row.style.display = "flex";
        row.style.alignItems = "center";
        row.style.gap = "8px";
        row.style.marginTop = "8px";

        const label = document.createElement("label");
        label.textContent = `${index}. Gradient color:`;
        label.style.minWidth = "140px";

        const input = document.createElement("input");
        input.type = "color";
        input.value = value;
        input.addEventListener("input", drawCape);

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";
        removeBtn.style.padding = "6px 10px";
        removeBtn.style.border = "none";
        removeBtn.style.borderRadius = "6px";
        removeBtn.style.cursor = "pointer";
        removeBtn.style.background = "rgba(255,255,255,0.1)";
        removeBtn.style.color = "#E1E1E6";
        removeBtn.addEventListener("click", () => {
          row.remove();
          relabelGradientRows();
          drawCape();
        });

        row.appendChild(label);
        row.appendChild(input);
        row.appendChild(removeBtn);
        gradientColorsEl.appendChild(row);
      }

      function relabelGradientRows() {
        const rows = gradientColorsEl.querySelectorAll(".grad-row");
        rows.forEach((row, i) => {
          const label = row.querySelector("label");
          if (label) label.textContent = `${i + 1}. Gradient color:`;
        });
      }

      function getGradientStops() {
        return Array.from(gradientColorsEl.querySelectorAll('input[type="color"]')).map(el => el.value);
      }

      function createGradient() {
        const dir = gradDirectionEl.value;
        const stops = getGradientStops();

        let grad;
        if (dir === "vertical") grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
        else if (dir === "horizontal") grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
        else grad = ctx.createLinearGradient(canvas.width, 0, 0, canvas.height);

        if (stops.length === 0) {
          grad.addColorStop(0, "#002aff");
          grad.addColorStop(1, "#002aff");
        } else if (stops.length === 1) {
          grad.addColorStop(0, stops[0]);
          grad.addColorStop(1, stops[0]);
        } else {
          const n = stops.length - 1;
          stops.forEach((c, i) => grad.addColorStop(i / n, c));
        }
        return grad;
      }

      function drawCape() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (templateReady) {
          ctx.globalCompositeOperation = "source-over";
          ctx.drawImage(templateImg, 0, 0);
        } else {
          ctx.globalCompositeOperation = "source-over";
        }

        const fillStyle = createGradient();
        ctx.globalCompositeOperation = "source-atop";
        ctx.fillStyle = fillStyle;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (templateReady) {
          ctx.globalCompositeOperation = "destination-over";
          ctx.drawImage(templateImg, 0, 0);
        }

        ctx.globalCompositeOperation = "source-over";

        if (frontImage) ctx.drawImage(frontImage, FRONT_X, FRONT_Y, FRONT_W, FRONT_H);
        if (backImage)  ctx.drawImage(backImage,  BACK_X,  BACK_Y,  BACK_W,  BACK_H);

        if (elytraImage && templateReady) {
          const maskCanvas = document.createElement("canvas");
          maskCanvas.width = ELYTRA_W; maskCanvas.height = ELYTRA_H;
          const maskCtx = maskCanvas.getContext("2d");

          maskCtx.drawImage(
            templateImg,
            ELYTRA_X, ELYTRA_Y, ELYTRA_W, ELYTRA_H,
            0, 0, ELYTRA_W, ELYTRA_H
          );

          const elyCanvas = document.createElement("canvas");
          elyCanvas.width = ELYTRA_W; elyCanvas.height = ELYTRA_H;
          const elyCtx = elyCanvas.getContext("2d");

          elyCtx.drawImage(elytraImage, 0, 0, ELYTRA_W, ELYTRA_H);
          elyCtx.globalCompositeOperation = "destination-in";
          elyCtx.drawImage(maskCanvas, 0, 0);

          ctx.drawImage(elyCanvas, ELYTRA_X, ELYTRA_Y);
        }
      }

      seedInitialGradientStops();

      addColorBtn.addEventListener("click", () => {
        addGradientColor("#ffffff");
        relabelGradientRows();
        drawCape();
      });

      gradDirectionEl.addEventListener("input", drawCape);

      document.getElementById("frontImageInput").addEventListener("change", e => {
        const file = e.target.files[0]; if (!file) return;
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => { frontImage = img; drawCape(); };
      });

      document.getElementById("backImageInput").addEventListener("change", e => {
        const file = e.target.files[0]; if (!file) return;
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => { backImage = img; drawCape(); };
      });

      document.getElementById("elytraImageInput").addEventListener("change", e => {
        const file = e.target.files[0]; if (!file) return;
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => { elytraImage = img; drawCape(); };
      });

      document.getElementById("downloadBtn").addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = "custom_cape.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });

      document.getElementById("resetBtn").addEventListener("click", () => {
        frontImage = null;
        backImage = null;
        elytraImage = null;

        document.getElementById("frontImageInput").value = "";
        document.getElementById("backImageInput").value = "";
        document.getElementById("elytraImageInput").value = "";

        gradientColorsEl.innerHTML = "";
        seedInitialGradientStops();
        gradDirectionEl.value = "vertical";

        drawCape();
      });

      drawCape();
    });
  </script>
</body>
</html>
